@using Test_Login.Models
@using Microsoft.AspNet.Identity
@{
    List<message>
    messageList = ViewBag.messageList;
}

<style>
    .msg {
        border: 5px solid #1C6EA4;
        margin: 10px;
        padding: 5px;
    }

    .rpl {
        border: 5px solid red;
        margin: 10px;
        padding: 5px;
    }

    /*Toggle Switch*/
    input[type=checkbox] {
        height: 0;
        width: 0;
        visibility: hidden;
    }

    label {
        cursor: pointer;
        width: 40px;
        height: 20px;
        background: grey;
        display: block;
        border-radius: 10px;
        position: relative;
    }

        label:after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 10px;
            height: 10px;
            background: #fff;
            border-radius: 10px;
            transition: 0.3s;
        }

    .switch-txt::before,
    .switch-txt::after {
        display: block;
        color: #fff;
        font-weight: bold;
        box-sizing: border-box;
    }

    .switch-txt::before {
        content: attr(turnOn);
        color: #fff;
    }

    .switch-txt::after {
        content: attr(turnOff);
        color: #ccc;
    }

    input:checked + label {
        background: #6f42c1;
    }

    label:active:after {
        width: 13px;
    }

    input:checked + label:after {
        left: calc(100% - 5px);
        transform: translateX(-100%);
    }
    /*Toggle Switch*/
</style>

<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<div class="container">
    @if (Request.IsAuthenticated)
    {
        <h2>討論區 有登入 @User.Identity.GetUserName()<span class="pull-right"><button id="newItem" class="btn btn-success btn-sm">發文</button></span></h2>
    }
    else
    {
        <h2>討論區 沒登入 @User.Identity.GetUserName() <span class="pull-right"><button id="newItem" class="btn btn-success btn-sm">發文</button></span></h2>
    }

    <button id="btnName" data-UserName="@User.Identity.GetUserName()" hidden></button>
    @*發文在這*@
    <div class="panel-group">
        @foreach (message message in messageList)
        {
            List<message> articleList = new List<message>();
            if (message.replyID == 0)
            {
                articleList.Add(message);
            }
            foreach (message article in articleList)
            {
                <div class="panel panel-primary msg">
                    <div class="panel-heading">@article.UserName<span class="pull-right">@article.initDate</span></div>
                    <div class="panel-body">

                        @article.main
                        <br />
                        <div>
                            @*Toggle Switch*@
                            <input type="checkbox" class="switch switchHeart" id="heart+@article.messageID" data-UserName="@User.Identity.GetUserName()" data-heart="@article.heart" data-messageID="@article.messageID" onchange="heartChange(this)" />
                            <label for="heart+@article.messageID">

                                @*<span class="switch-txt" turnOn="讚" turnOff="取消"></span>*@
                            </label>
                            <span id="heartCnt+@article.messageID" data-heart="@article.heart" data-messageID="@article.messageID">推 @article.heart</span>
                            @*Toggle Switch*@
                            @*Toggle Switch*@
                            <input type="checkbox" class="switch switchDislike" id="dislike+@article.messageID" />
                            <label for="dislike+@article.messageID">
                                @*<span class="switch-txt" turnOn="讚" turnOff="取消"></span>*@
                            </label>
                            <span>噓 @article.dislike</span>
                            @*Toggle Switch*@
                            @*<button class="btntest btnHeart+@article.messageID btn btn-success" id="heart+@article.messageID" AutoPostBack="true" data-messageID="@article.messageID" data-heart="@article.heart" alt="Add Password">推 @article.heart</button>
                                <button class="btntest btnDislike+@article.messageID btn btn-danger" id="dislike+@article.messageID" AutoPostBack="true" data-messageID="@article.messageID" data-dislike="@article.dislike" alt="Add Password">噓 @article.dislike</button>*@
                            <br />
                            <button class="btn btnRelpy btn-secondary " data-messageID="@article.messageID">回覆</button>
                        </div>
                        <br />

                        @*回覆在這*@
                        @foreach (message reply in messageList)
                        {
                            if (reply.replyID == article.messageID)
                            {

                                <div class="panel panel-info rpl">
                                    <div class="panel-heading">@reply.UserName<span class="pull-right">@reply.initDate</span></div>
                                    <div class="panel-body">
                                        @reply.main
                                        <br />
                                        <button class="btntest btnHeart+@reply.messageID btn btn-success" id="heart+@reply.messageID" AutoPostBack="true" data-messageID="@reply.messageID" data-heart="@reply.heart" alt="Add Password">推 @reply.heart</button>
                                        <button class="btntest btnDislike+@reply.messageID btn btn-danger" id="dislike+@reply.messageID" AutoPostBack="true" data-messageID="@reply.messageID" data-dislike="@reply.dislike" alt="Add Password">噓 @reply.dislike</button>
                                    </div>
                                </div>
                            }
                        }
                        @*回覆結束*@
                    </div>
                </div>
            }
        }
    </div>
    @*發文結束*@

    <!-- 新增貼文 -->
    <div id="newsModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">發文</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/Home/Message">
                        <div class="form-group">
                            @*<label for="UserNameBox">*@
                            <span class="glyphicon glyphicon-bullhorn"></span>
                            使用者名稱
                            @*</label>*@
                            <input type="text"
                                   name="UserNameBox"
                                   class="form-control"
                                   placeholder="使用者名稱"
                                   value="@User.Identity.GetUserName()"
                                   readonly />
                        </div>

                        <div class="form-group">
                            @*<label for="mainBox">*@
                            <span class="glyphicon glyphicon-time"></span>
                            在想些什麼呢?
                            @*</label>*@
                            <input type="text"
                                   name="UserIdbox"
                                   value="@User.Identity.GetUserName()"
                                   hidden>
                            <textarea class="form-control"
                                      name="mainBox"
                                      id="exampleFormControlTextarea1"
                                      rows="3"></textarea>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">發文</button>
                        </div>

                    </form>
                </div>

            </div>
        </div>
    </div>
    <!-- 新增貼文 -->
    <!-- 回覆貼文 -->
    <div id="replyModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">回覆</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form method="post" action="/Home/Reply">
                        <div>
                            <input type="text" id="messageID" name="messageID" value="0" hidden />
                        </div>
                        <div class="form-group">
                            @*<label for="UserNameBox">*@
                            <span class="glyphicon glyphicon-bullhorn"></span>
                            使用者名稱
                            @*</label>*@
                            <input type="text"
                                   name="UserNameBox"
                                   class="form-control"
                                   placeholder="使用者名稱"
                                   value="@User.Identity.GetUserName()"
                                   readonly />
                        </div>

                        <div class="form-group">
                            @*<label for="mainBox">*@
                            <span class="glyphicon glyphicon-time"></span>
                            回覆內容
                            @*</label>*@
                            <input type="text"
                                   name="UserIdbox"
                                   value="@User.Identity.GetUserName()"
                                   hidden>
                            <textarea class="form-control"
                                      name="mainBox"
                                      id="exampleFormControlTextarea1"
                                      rows="3"></textarea>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">回覆</button>
                        </div>

                    </form>
                </div>

            </div>
        </div>
    </div>
    <!-- 回覆貼文 -->
</div>

<script src="~/Scripts/bootstrap.min.js"></script>
<script src="~/Scripts/jquery-3.4.1.js"></script>
<script src="~/Content/vendor.css"></script>
<script>
    let name = document.getElementById('btnName').dataset.username
    $("#newItem").click(function () {
        $("#newsModal").modal({ backdrop: "static" });
    })

    $(".btnRelpy").click(function () {
        $("#messageID").val(this.dataset.messageid);
        $("#replyModal").modal({ backdrop: "static" });
    })

    $(".btntest").click(function () {
        var message = {
            messageID: 0,
            heart: -1,
            dislike: -1
        }
        message.messageID = this.dataset.messageid;
        message.heart = this.dataset.heart;
        message.dislike = this.dataset.dislike;
        if (message.heart) {
            //alert("true")
            console.log(message.heart);
            console.log(message.dislike);
            console.log('message.heart != -1');
            $.ajax({
                type: "post",
                url: "/Home/APILike",
                data: message
            }).then(function (e) {
                document.getElementById(`heart+${message.messageID}`).innerHTML = `讚 ${e.heart}`;
                document.getElementById(`heart+${message.messageID}`).dataset.heart = e.heart;
            })
        }
        else {
            console.log(message.heart);
            console.log(message.dislike);
            console.log('else');
            //alert("false")
            $.ajax({
                type: "post",
                url: "/Home/APIDislike",
                data: message
            }).then(function (e) {
                document.getElementById(`dislike+${message.messageID}`).innerHTML = `倒讚 ${e.dislike}`;
                document.getElementById(`dislike+${message.messageID}`).dataset.dislike = e.dislike;
            })
        }

    })

    $('.switchHeart')
    $(".btnHeart").click(function () {
        /*     console.log("/home/Index/" + this.dataset.messageid);*/
        //$.ajax({
        //    type: "put",
        //    url: "/home/Index" + this.dataset.messageid,
        //    data: newsList[currentIndex]
        //})
        //    .then(function (e) {
        //        showToast(e);
        //    })
    })

    $('#test').click(function () {

        alert('ok');
    })
    $('#btnName').click(function () {
        alert(document.getElementById('btnName').dataset.UserName)
    })
    function heartChange(cb) {
        //console.log(cb.dataset.UserName);
        var message = {
            messageID: 0,
            heart: -1,
            dislike: -1,
            UserName: name,
            UserId: name
        }
        if (cb.checked) {
            // 案讚
            //console.log(cb.dataset.heart);
            //console.log(cb.dataset.messageid);
            message.messageID = cb.dataset.messageid;
            message.heart = cb.dataset.heart;
            console.log(message.UserName);
            $.ajax({
                type: "post",
                url: "/Home/APILike",
                data: message
            }).then(function (e) {
                document.getElementById(`heartCnt+${message.messageID}`).innerHTML = `推 ${e.heart}`;
                document.getElementById(`heart+${message.messageID}`).dataset.heart = e.heart;
                document.getElementById(`heartCnt+${message.messageID}`).dataset.heart = e.heart;
            })

        } else {
            // 取消讚
            message.messageID = cb.dataset.messageid;
            message.heart = cb.dataset.heart;
            //console.log(message.UserName);
            $.ajax({
                type: "post",
                url: "/Home/APILikeCancel",
                data: message
            }).then(function (e) {
                document.getElementById(`heartCnt+${message.messageID}`).innerHTML = `推 ${e.heart}`;
                document.getElementById(`heart+${message.messageID}`).dataset.heart = e.heart;
                document.getElementById(`heartCnt+${message.messageID}`).dataset.heart = e.heart;
            })
        }
        //console.log(cb.dataset.messageid);

    }


    $(".btnDislike").click(function () {
        console.log(this.dataset.messageid);
    })



</script>
